{
	# Optional: enable access logs
	# debug
}

api.4.187.225.54.nip.io {
	encode zstd gzip
	# CORS at proxy layer (reflect origin) to satisfy preflight if backend isn't reached
	@hasOrigin header Origin *
	header @hasOrigin {
		Access-Control-Allow-Origin "{http.request.header.Origin}"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Headers "Authorization, Content-Type"
		Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
		Vary "Origin"
	}

	@preflight {
		method OPTIONS
		header Origin *
	}
	respond @preflight 204
	@api {
		path /health*
		path /ready*
		path /api/*
		path /auth/*
	}
	reverse_proxy @api api:5000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-For {remote}
	}

	# Pass everything else to AI service if needed (optional endpoint base)
	@ai {
		path /check
		path /highlight_pdf
	}
	reverse_proxy @ai ai:8000

	# Basic security headers (Caddy v2 directive is 'header')
	header {
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer"
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}
}
