{
	# Optional: enable access logs
	# debug
}

api.4.187.225.54.nip.io {
	encode zstd gzip

	# --- CORS HANDLING ---

	# Define matcher for API + auth routes
	@api {
		path /health*
		path /ready*
		path /api/*
		path /auth/*
	}

	# Handle preflight (OPTIONS) requests locally
	@preflight {
		method OPTIONS
		header Origin *
		path /api/* /auth/*
	}

	# Respond 204 (no content) for preflight
	respond @preflight 204

	# Add the CORS headers for preflight responses
	header @preflight {
		Access-Control-Allow-Origin "https://ai-project-ten-lilac.vercel.app"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type, Accept, X-Requested-With"
		Vary "Origin"
	}

	# Proxy API/auth traffic
	reverse_proxy @api api:5000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-For {remote}
		header_down -Access-Control-Allow-Origin
		header_down -Access-Control-Allow-Credentials
		header_down -Access-Control-Allow-Methods
		header_down -Access-Control-Allow-Headers
		header_down -Vary
	}

	# Inject unified CORS headers for API/auth responses
	@apiCors {
		header Origin *
		path /api/* /auth/*
	}
	header @apiCors {
		Access-Control-Allow-Origin "https://ai-project-ten-lilac.vercel.app"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type, Accept, X-Requested-With"
		Vary "Origin"
	}

	# --- AI SERVICE ROUTES ---
	@ai {
		path /check
		path /highlight_pdf
	}
	reverse_proxy @ai ai:8000

	# --- SECURITY HEADERS ---
	header {
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer"
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}
}
