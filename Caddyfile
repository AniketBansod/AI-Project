{
	# Optional: enable access logs
	# debug
}

api.4.187.225.54.nip.io {
	encode zstd gzip
	# Centralized CORS handling at edge (Caddy). We STRIP any upstream CORS headers
	# to prevent duplication and set a single consistent set here.

	# Define matcher for API + auth routes we proxy to Node backend
	@api {
		path /health*
		path /ready*
		path /api/*
		path /auth/*
	}

	# Preflight (OPTIONS) requests must be answered quickly without hitting upstream
	@preflight {
		method OPTIONS
		header Origin *
		path /api/* /auth/*
	}
	respond @preflight 204 {
		headers {
			Access-Control-Allow-Origin "https://ai-project-ten-lilac.vercel.app"
			Access-Control-Allow-Credentials "true"
			Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
			Access-Control-Allow-Headers "Authorization, Content-Type, Accept, X-Requested-With"
			Vary "Origin"
		}
	}

	# Proxy actual API/auth traffic; strip any CORS headers coming back
	reverse_proxy @api api:5000 {
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-For {remote}
		header_down -Access-Control-Allow-Origin
		header_down -Access-Control-Allow-Credentials
		header_down -Access-Control-Allow-Methods
		header_down -Access-Control-Allow-Headers
		header_down -Vary
	}

	# Inject single authoritative CORS headers on all API/auth responses (non-preflight)
	@apiCors {
		header Origin *
		path /api/* /auth/*
	}
	header @apiCors {
		Access-Control-Allow-Origin "https://ai-project-ten-lilac.vercel.app"
		Access-Control-Allow-Credentials "true"
		Access-Control-Allow-Methods "GET,POST,PUT,PATCH,DELETE,OPTIONS"
		Access-Control-Allow-Headers "Authorization, Content-Type, Accept, X-Requested-With"
		Vary "Origin"
	}

	# Pass everything else to AI service if needed (optional endpoint base)
	@ai {
		path /check
		path /highlight_pdf
	}
	reverse_proxy @ai ai:8000

	# Basic security headers (Caddy v2 directive is 'header')
	header {
		X-Frame-Options "DENY"
		X-Content-Type-Options "nosniff"
		Referrer-Policy "no-referrer"
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
	}
}
